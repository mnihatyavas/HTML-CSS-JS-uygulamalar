// C1c45c.js: Katagori ve terimli ürün resimleri sergileme XML kodlaması alt-örneği.
const talep = new XMLHttpRequest();
talep.open ("GET", "C1c45c.json");
talep.responseType = "json";
talep.onload = function() {
    if (talep.status === 200) {// Okunacak dosya mevcutsa...
        let ürünler = talep.response;
        uygulamayıÇalıştır (ürünler);
    }else {console.log ("JSON dosyası mevcut değil. HATA: " + talep.status + "=" + talep.statusText); }
}; // tal..sonu...
talep.send();

function uygulamayıÇalıştır (ürünler) {
    const seçilenKatagori = document.querySelector ("#katagori");
    const arananİbare = document.querySelector ("#araştırılacakİbare");
    const aramaDüğmesi = document.querySelector ("button");
    const esas = document.querySelector ("main");

    let sonKatagori = seçilenKatagori.value;
    let sonAraştırma = "";
    let katagoriGrubu; // Seçili katagori
    let finalGrubu; // Aranan ibare yoksa, katagoriGrubu, varsa katagoriGrubu'nda (burada "Tüm") bulunan ürünler...
    finalGrubu = ürünler; // İlk başlarken tüm ürünleri sergiler...
    sergiyiGüncelle();

    katagoriGrubu = []; // Araştırma başında henüz ürün yok farzet...
    finalGrubu = [];
    aramaDüğmesi.onclick = katagoriyiSeç; // Tıklandığında katagoriyi ve araştırılacak ibareyi kontrol et...
    function katagoriyiSeç (o) {
        o.preventDefault(); // Varsayılıdan vazgeç...
        katagoriGrubu = []; // Bir önceki tıklanan tarama verilerini temizle...
        finalGrubu = [];
        if (seçilenKatagori.value === sonKatagori && arananİbare.value.trim() === sonAraştırma) {return;
        }else {// Katagori ve/veya İbare değişikliği varsa...
            sonKatagori = seçilenKatagori.value;
            sonAraştırma = arananİbare.value.trim();
            if (seçilenKatagori.value === "Tümü") {
                katagoriGrubu = ürünler;
                ürünleriSeç();
            }else {// katagoriGrubu tümü değilse sınırlı katori ürünlerini ekle...
                let küçükHarfliKatagori = seçilenKatagori.value.toLowerCase(); // Select büyük harfbaşlangıcını json küçük tip'le uyumlat...
                for (let i = 0; i < ürünler.length ; i++) {if (ürünler [i].tip === küçükHarfliKatagori) {katagoriGrubu.push (ürünler [i]);}}
                ürünleriSeç();
            } // else-iç sonu...
        } // else-dış sonu...
    } // func sonu...

    function ürünleriSeç() {
        if (arananİbare.value.trim() === "") {// Aranan ibare yoksa, finalGrubu katagoriGrubu'dur...
            finalGrubu = katagoriGrubu;
            sergiyiGüncelle();
        }else {// İbare varsa, finalGrubu tüm ürünlerin adında taranan uyumlu ürünler'dir...
            let küçükHarfliİbare = arananİbare.value.trim().toLowerCase();
            for (let i = 0; i < ürünler.length ; i++) {if (ürünler [i].ad.indexOf (küçükHarfliİbare) !== -1) {finalGrubu.push (ürünler [i]);} }
            sergiyiGüncelle();
        } // else sonu...
    } // func sonu...

    function sergiyiGüncelle() {
        while (esas.firstChild) {esas.removeChild (esas.firstChild);} // Önceden sergileneni temizle...
        if (finalGrubu.length === 0) {// Seçilen katagoriden aranan ibareye hiç raslanmamışsa...
            const paragraf = document.createElement ("p");
            paragraf.textContent = "Aranan terim tüm ürün adları içeriklerinde hiç rastlanmadı!";
            esas.appendChild (paragraf);
        }else {for (let i = 0; i < finalGrubu.length; i++) {damlayıGetir (finalGrubu [i]);} } // finalGrubu içeriklerini tek tek yükleyip main-section'da sergile...
    } // func sonu...

    function damlayıGetir (ürün) {
        let resimYolu = "resim/konserve/" + ürün.resim;
        const talep = new XMLHttpRequest();
        talep.open ("GET", resimYolu);
        talep.responseType = "blob";
        talep.onload = function() {
            if (talep.status === 200) {// Resim dosyası mevcutsa...
                let damla = talep.response;
                let resimNesnesi = URL.createObjectURL (damla);
                ürünüGöster (resimNesnesi, ürün);
            }else {console.log (ürün.ad + " isimli resim dosyası okunamadı. HATA: " + talep.status + "=" + talep.statusText);}
        }; // tal..sonu...
        talep.send();
    } // func sonu...

    function ürünüGöster (resimNesnesi, ürün) {
        // Dinamik <section>, <h2>, <p>, ve <img> elemanları yaratılacak...
        const kısım = document.createElement ("section");
        const h2Başlık = document.createElement ("h2");
        const fiyatParagrafı = document.createElement ("p");
        const resim = document.createElement ("img");
        kısım.setAttribute ("class", ürün.tip); // ürün.tip url-ikon doğrudan css'den yüklenecek...

        h2Başlık.textContent = ürün.ad.replace (ürün.ad.charAt (0), ürün.ad.charAt (0).toUpperCase()); // Ürün adı başharfi büyük olacak...
        fiyatParagrafı.textContent = "TL" + (ürün.fiyat * 8.45).toFixed (2); // TL fiyat 2 ondalık haneli ve $/TL kur ayarlı olacak...
        resim.src = resimNesnesi;
        resim.alt = ürün.ad;

        kısım.appendChild (h2Başlık); // h2Başlık, yuvarlak paftalı fiyat, ürün resmi, css'den ürün ikonu==> section'a eklenecek...
        kısım.appendChild (fiyatParagrafı);
        kısım.appendChild (resim);
        esas.appendChild (kısım); // Resimli section main'a eklenecek...
    } // func sonu...
} // func(uygulamayıÇalıştır) sonu...